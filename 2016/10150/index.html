<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 代理与爬虫的尝试 · 一环的笔记</title><meta name="description" content="代理与爬虫的尝试 - liyh"><meta name="description" content="国庆的时候发现了一个小游戏，积分可以通过分享好友并点击链接获得，判定挺简单的样子。于是为了买到新皮肤，开始动手尝试。">
<meta property="og:type" content="article">
<meta property="og:title" content="代理与爬虫的尝试">
<meta property="og:url" content="http://cupools.github.io/2016/10150/index.html">
<meta property="og:site_name" content="一环的笔记">
<meta property="og:description" content="国庆的时候发现了一个小游戏，积分可以通过分享好友并点击链接获得，判定挺简单的样子。于是为了买到新皮肤，开始动手尝试。">
<meta property="og:image" content="http://cupools.github.io/images/201610150/screenshoot.png">
<meta property="og:image" content="http://cupools.github.io/images/201610150/proxy.png">
<meta property="og:updated_time" content="2016-10-15T07:43:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代理与爬虫的尝试">
<meta name="twitter:description" content="国庆的时候发现了一个小游戏，积分可以通过分享好友并点击链接获得，判定挺简单的样子。于是为了买到新皮肤，开始动手尝试。">
<meta name="twitter:image" content="http://cupools.github.io/images/201610150/screenshoot.png"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://cupools.github.io/atom.xml" title="一环的笔记"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/archives/" target="" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="https://github.com/cupools" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="mailto:cupools@gmail.com" target="" class="nav-list-link">Gmail</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">代理与爬虫的尝试</h1><div class="post-info">Oct 15, 2016<ul class="post-tag-list"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/学习/">学习</a></li></ul></div><div class="post-content"><p>国庆的时候发现了一个小游戏，积分可以通过分享好友并点击链接获得，判定挺简单的样子。于是为了买到新皮肤，开始动手尝试。</p>
<a id="more"></a>
<p><img src="/images/201610150/screenshoot.png" alt="screenshoot"></p>
<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><p>首先断开 WiFi，通过移动网络再次访问链接，积分增加。恩第一步就成功了，看来是通过 IP 判断的。</p>
<p>然后尝试修改请求 Header 的 X-Forwarded-For 并向目标发起请求，发现积分并没有增加。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ curl http://xxx.me/ -H <span class="string">'X-Forwarded-For: 1.1.1.1'</span> -I</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: Tengine</div><div class="line">Content-Type: text/html</div><div class="line">Content-Length: 7823</div><div class="line">Connection: keep-alive</div><div class="line">...</div></pre></td></tr></table></figure>
<p>那对方可能是通过 remoteAddress 获取 IP 的，谷歌 “免费代理 IP” 终于找到一个有用的，再次发起请求，发现积分增加了，好开心呀</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ curl -x 122.96.59.104:81 http://xxx.me -I</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: Tengine</div><div class="line">Content-Type: text/html</div><div class="line">Content-Length: 7823</div><div class="line">Connection: keep-alive</div><div class="line">...</div></pre></td></tr></table></figure>
<p>就这样简单搞定啦。</p>
<p>然后简单提一下 X-Forwarded-For 和 remoteAddress。前者是一个 HTTP 扩展头部，请求从客户端到达目标服务器的过程中，中间经过的代理服务器（反向代理或者非高度匿名的正向代理）会把客户端的真实 IP 和代理 IP 记录在 X-Forwarded-For 中，类似 <code>X-Forwarded-For: client, proxy0, proxy1</code>，但由于头部可被自由修改所以不可信；后者无法伪造，否则无法在客户端和服务器之间建立连接。</p>
<p>而使用高度匿名的正向代理的话，代理服务器将我们的数据包原封不动的转发，在服务端看来就好像真的是一个普通客户端在访问，而记录的IP是代理服务器的IP。</p>
<p><img src="/images/201610150/proxy.png" alt="proxy"></p>
<p>然后每次手动寻找靠谱的代理 IP 然后发起请求效率太低啦，于是就继续看爬虫要怎么搞了。</p>
<h2 id="爬虫"><a href="#爬虫" class="headerlink" title="爬虫"></a>爬虫</h2><p>这里简单地爬取页面表格中的代理 IP，程序访问页面获得 HTML 文本然后过滤得到有效的信息，大概是这样的做法。每次爬取完成后直接使用而不入库，因为免费的 IP 质量太低啦而且我也不需要很大的量，类似的功能用 Node.js 配合 <a href="https://github.com/cheeriojs/cheerio" target="_blank" rel="external">cherrio</a> 就可以完成了（这个时候会想自己是个前端真是太好了）。</p>
<p>简单代码如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'request'</span></div><div class="line"><span class="keyword">import</span> cheerio <span class="keyword">from</span> <span class="string">'cheerio'</span></div><div class="line"><span class="comment">// request 配置</span></div><div class="line"><span class="keyword">let</span> option = &#123;</div><div class="line">  url: <span class="string">'http://free.ip'</span>,</div><div class="line">  timeout: <span class="number">5e3</span>,</div><div class="line">  headers: &#123;</div><div class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 处理回调</span></div><div class="line"><span class="keyword">let</span> callback = <span class="function"><span class="keyword">function</span> (<span class="params">process</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">err, response, body</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!error &amp;&amp; response.statusCode === <span class="number">200</span>) &#123;</div><div class="line">      process(body)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 收集 IP</span></div><div class="line"><span class="keyword">let</span> process = <span class="function"><span class="keyword">function</span> (<span class="params">body</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> $ = cheerio.load(body)</div><div class="line">  $(<span class="string">'#list .ip'</span>)</div><div class="line">    .map(</div><div class="line">      (index, el) =&gt; $(el).text()</div><div class="line">    )</div><div class="line">    .forEach(</div><div class="line">      ip =&gt; <span class="built_in">console</span>.log(ip)</div><div class="line">    )</div><div class="line">&#125;</div><div class="line"><span class="comment">// 发起请求</span></div><div class="line">request(option, callback(process))</div></pre></td></tr></table></figure>
<p>然后这里模拟 UA 是因为如果 UA 不合理部分网站会直接拒绝请求。</p>
<p>类似的功能也封装成了 <a href="https://github.com/cupools/faker" target="_blank" rel="external">Faker</a>，可以很方便地爬取数据和扩展。示例如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> faker <span class="keyword">from</span> <span class="string">'faker'</span></div><div class="line"></div><div class="line">faker</div><div class="line">  .extend(<span class="built_in">require</span>(<span class="string">'faker/extend/xicidaili'</span>))</div><div class="line">  .run()</div><div class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params">hosts</span>) </span>&#123;</div><div class="line">    <span class="comment">// hosts =&gt; ['http://100.10.10.10:80', ...]</span></div><div class="line">    <span class="comment">// do something</span></div><div class="line">  &#125;)</div></pre></td></tr></table></figure>
<p>大概内容就这些，皮肤也买到啦，玩的开心~</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/10130/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 <a href="http://cupools.github.io">liyh</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-67000695-1",'auto');ga('send','pageview');</script></body></html>