<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Hot Module Replacement 介绍 - 一环的笔记</title><meta name="description" content="Hot Module Replacement 介绍 - liyh"><meta name="description" content="Hot Module Replacement (HMR) exchanges, adds, or removes modules while an application is running without a page reload.

HMR（模块热替换）带来了比 LiveReload 更加愉悦的开发体验，允许在不刷新页面的情况下更新改动的模块。这里的模块包括 JS, CSS, 图片等，部">
<meta property="og:type" content="article">
<meta property="og:title" content="Hot Module Replacement 介绍">
<meta property="og:url" content="http://cupools.github.io/2016/07010/index.html">
<meta property="og:site_name" content="一环的笔记">
<meta property="og:description" content="Hot Module Replacement (HMR) exchanges, adds, or removes modules while an application is running without a page reload.

HMR（模块热替换）带来了比 LiveReload 更加愉悦的开发体验，允许在不刷新页面的情况下更新改动的模块。这里的模块包括 JS, CSS, 图片等，部">
<meta property="og:updated_time" content="2016-08-26T14:12:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hot Module Replacement 介绍">
<meta name="twitter:description" content="Hot Module Replacement (HMR) exchanges, adds, or removes modules while an application is running without a page reload.

HMR（模块热替换）带来了比 LiveReload 更加愉悦的开发体验，允许在不刷新页面的情况下更新改动的模块。这里的模块包括 JS, CSS, 图片等，部"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://cupools.github.io/atom.xml" title="一环的笔记"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/cupools" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="mailto:cupools@gmail.com" target="_self" class="nav-list-link">GMAIL</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Hot Module Replacement 介绍</h1><div class="post-info">Jul 1, 2016<ul class="post-tag-list"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/webpack/">webpack</a></li></ul></div><div class="post-content"><blockquote>
<p>Hot Module Replacement (HMR) exchanges, adds, or removes modules while an application is running without a page reload.</p>
</blockquote>
<p>HMR（模块热替换）带来了比 LiveReload 更加愉悦的开发体验，允许在不刷新页面的情况下更新改动的模块。这里的模块包括 JS, CSS, 图片等，部分模块如 HTML 如果不允许热替换则会触发页面刷新。如果是 React 开发的话，写一个下午代码可能也不需要刷新页面的说（当然 Redux 和 React-Router 要折腾一下先）。</p>
<a id="more"></a>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><blockquote>
<p>Webpacks adds a small HMR runtime to the bundle, during the build process, that runs inside your app. When the build completes, Webpack does not exit but stays active, watching the source files for changes. If Webpack detects a source file change, it rebuilds only the changed module(s). Depending on the settings, Webpack will either send a signal to the HMR runtime, or the HMR runtime will poll webpack for changes. Either way, the changed module is sent to the HMR runtime which then tries to apply the hot update. First it checks whether the updated module can self-accept. If not, it checks those modules that have required the updated module. If these too do not accept the update, it bubbles up another level, to the modules that required the modules that required the changed module. This bubbling-up will continue until either the update is accepted, or the app entry point is reached, in which case the hot update fails.</p>
</blockquote>
<p>差不多就是在开发构建的过程中，webpack 将 HMR 相关的 <a href="https://github.com/webpack/webpack/blob/master/lib/HotModuleReplacement.runtime.js" target="_blank" rel="external">runtime</a> 同时打包到项目中，然后 webpack 监听文件改动，在增量编译之后将改动的模块信息通过 EventSource 发送到浏览器端，HMR runtime 收到信号后判断改动的模块是否接受更新，否则更新事件向上冒泡。这里判断是否接受更新的依据是模块会带有如下代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">...</div><div class="line">if(<span class="built_in">module</span>.hot) &#123;</div><div class="line">    <span class="built_in">module</span>.hot.accept();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="module-hot"><a href="#module-hot" class="headerlink" title="module.hot"></a>module.hot</h2><p>module.hot 的常见方法如下</p>
<h3 id="accept"><a href="#accept" class="headerlink" title="accept"></a>accept</h3><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">accept(dependencies: string[], callback: (updatedDependencies) =&gt; <span class="keyword">void</span>) =&gt; <span class="keyword">void</span></div><div class="line">accept(dependency: string, callback: () =&gt; <span class="keyword">void</span>) =&gt; <span class="keyword">void</span></div></pre></td></tr></table></figure>
<p>接受指定依赖模块的代码更新。<code>callback</code> 将在依赖模块被替换的时候调用。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">accept([errHandler]) =&gt; <span class="keyword">void</span></div></pre></td></tr></table></figure>
<p>接受本模块的代码更新且不通知 parents 模块。如果模块没有 exports 任何方法或者属性，则应该用这种方法接受更新。<code>errHandler</code> 将在加载更新模块抛出异常的时候被调用。</p>
<h3 id="decline"><a href="#decline" class="headerlink" title="decline"></a>decline</h3><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">decline(dependencies: string[]) =&gt; <span class="keyword">void</span></div><div class="line">decline(dependency: string) =&gt; <span class="keyword">void</span></div></pre></td></tr></table></figure>
<p>不接受指定依赖模块的更新。如果依赖模块发生代码变动，则更新会被 <code>decline</code> 的状态码停止。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">decline() =&gt; void</div></pre></td></tr></table></figure>
<p>标识当前模块不接受模块热替换。如果当前模块发生代码变动，则更新会被 <code>decline</code> 的状态码停止。</p>
<h3 id="dispose-addDisposeHandler"><a href="#dispose-addDisposeHandler" class="headerlink" title="dispose/addDisposeHandler"></a>dispose/addDisposeHandler</h3><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">dispose(callback: (data: object) =&gt; <span class="keyword">void</span>) =&gt; <span class="keyword">void</span></div><div class="line">addDisposeHandler(callback: (data: object) =&gt; <span class="keyword">void</span>) =&gt; <span class="keyword">void</span></div></pre></td></tr></table></figure>
<p>添加一个 one time handler, 在当前模块发生热替换的时候执行。允许销毁和移除之前声明或者创建的内容（比如绑定的 DOM 事件）。如果想从旧的模块传递状态到更新后的模块，可以把数据放在 data 对象。在替换后的模块中允许通过 module.hot.data 访问。</p>
<h3 id="removeDisposeHandler"><a href="#removeDisposeHandler" class="headerlink" title="removeDisposeHandler"></a>removeDisposeHandler</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">removeDisposeHandler(callback: (data: object) =&gt; void) =&gt; void</div></pre></td></tr></table></figure>
<p>移除 handler。允许添加临时的 dispose handler, 并在需要的时候移除。比如在多个步骤的异步函数执行的过程中，如果进行代码热替换则需要触发 handler 销毁状态，而当执行完成时可以移除 handler。</p>
<p>更多内容见 <a href="https://github.com/webpack/docs/wiki/hot-module-replacement" target="_blank" rel="external">Github wiki</a></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>这里提供一个简单配置的例子，使用 <a href="https://github.com/webpack/webpack-dev-server" target="_blank" rel="external">webpack-dev-server</a> 作为开发服务器并配置启用 HMR。</p>
<h3 id="webpack-config-js"><a href="#webpack-config-js" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h3><p>配置文件需要关注的是 <code>entry</code>, <code>output.publicPath</code> 和 <code>plugins</code>。</p>
<h3 id="entry"><a href="#entry" class="headerlink" title="- entry"></a>- <code>entry</code></h3><p>需要在每个入口文件注入 runtime，以便浏览器能够处理更新信号。同时也需要带上开发服务器的 IP 和端口。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">entry: [</div><div class="line">    <span class="string">'webpack-dev-server/client?http://127.0.0.1:3000'</span>,</div><div class="line">    <span class="string">'webpack/hot/dev-server'</span>,</div><div class="line">    <span class="string">'./src/index.js'</span></div><div class="line">],</div></pre></td></tr></table></figure>
<h3 id="output-publicPath"><a href="#output-publicPath" class="headerlink" title="- output.publicPath"></a>- <code>output.publicPath</code></h3><p><code>publicPath</code> 是发布路径，需要与 <code>path</code> 构建输出路径区分开。这里设置为 <code>/</code>，则在开发服务器中引用打包文件的方式为 <code>http://127.0.0.1/bundle.js</code></p>
<h3 id="plugins"><a href="#plugins" class="headerlink" title="- plugins"></a>- <code>plugins</code></h3><p>需要在 <code>plugins</code> 中增加两个插件如下。前者在增量编译的过程中提供热替换所使用的模块 (updated chunks)，后者使得在编译过程抛出异常时不会输出错误的构建资源，也不会触发 HMR。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">plugins: [</div><div class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</div><div class="line">    <span class="keyword">new</span> webpack.NoErrorsPlugin()</div><div class="line">],</div></pre></td></tr></table></figure>
<p>完整的配置文件如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// webpack.config.js</span></div><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    entry: [</div><div class="line">        <span class="string">'webpack-dev-server/client?http://127.0.0.1:3000'</span>,</div><div class="line">        <span class="string">'webpack/hot/dev-server'</span>,</div><div class="line">        <span class="string">'./src/index.js'</span></div><div class="line">    ],</div><div class="line">    output: &#123;</div><div class="line">        path: path.join(process.cwd(), <span class="string">'build/asserts/'</span>),</div><div class="line">        filename: <span class="string">'bundle.js'</span>,</div><div class="line">        publicPath: <span class="string">'/'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="built_in">module</span>: &#123;</div><div class="line">        loaders: [&#123;</div><div class="line">            test: <span class="regexp">/\.js?$/</span>,</div><div class="line">            loader: <span class="string">'babel?presets[]=es2015'</span>,</div><div class="line">            exclude: <span class="regexp">/node_modules/</span></div><div class="line">        &#125;]</div><div class="line">    &#125;,</div><div class="line">    plugins: [</div><div class="line">        <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</div><div class="line">        <span class="keyword">new</span> webpack.NoErrorsPlugin()</div><div class="line">    ],</div><div class="line">    devtool: <span class="string">'eval'</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="server-js"><a href="#server-js" class="headerlink" title="server.js"></a>server.js</h3><p>通过 <a href="https://github.com/webpack/webpack-dev-server" target="_blank" rel="external">webpack-dev-server</a> 启用开发服务器。实际开发过程中，直接启用服务器就能根据 webpack.config.js 的配置内容编译并监听文件改动。配置方式如下，比较简单。值得注意的是控制台输出信息的配置需要在这里控制。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// server.js</span></div><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</div><div class="line"><span class="keyword">var</span> WebpackDevServer = <span class="built_in">require</span>(<span class="string">'webpack-dev-server'</span>);</div><div class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'./webpack.config.js'</span>);</div><div class="line"></div><div class="line"><span class="keyword">new</span> WebpackDevServer(webpack(config), &#123;</div><div class="line">    publicPath: config.output.publicPath,</div><div class="line">    hot: <span class="literal">true</span>,</div><div class="line">    historyApiFallback: <span class="literal">true</span>,</div><div class="line">    stats: &#123;</div><div class="line">        colors: <span class="literal">true</span>,</div><div class="line">        noInfo: <span class="literal">true</span>,</div><div class="line">        quiet: <span class="literal">true</span>,</div><div class="line">        chunks: <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">&#125;).listen(<span class="number">3000</span>, <span class="string">'127.0.0.1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">        <span class="built_in">console</span>.log(err);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Listening at http://127.0.0.1:3000'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="index-html-amp-index-js"><a href="#index-html-amp-index-js" class="headerlink" title="index.html &amp; index.js"></a>index.html &amp; index.js</h3><p>在根目录下准备一个 index.html 做为测试页面，同时准备好入口文件 src/index.js</p>
<figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://127.0.0.1:3000/bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// index.js</span></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'It works'</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(<span class="built_in">module</span>.hot) &#123;</div><div class="line">    <span class="built_in">module</span>.hot.accept();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要注意的地方是，需要带上 module.hot 以接受更新替换，否则可以在浏览器控制台看到更新信息，模块却没有被替换。详细见 <a href="#module.hot">module.hot</a></p>
<h3 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ node server.js</div></pre></td></tr></table></figure>
<p>访问 <a href="http://127.0.0.1:3000/" target="_blank" rel="external">http://127.0.0.1:3000/</a></p>
<p>已经完成了所有工作，可以尝试修改 index.js 并通过浏览器控制台查看更新结果了。完整代码见 <a href="https://github.com/cupools/webpack-demo/tree/master/bootstrap" target="_blank" rel="external">Github</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>如果是与其他服务器配合使用 HMR 的话，需要 <a href="https://github.com/webpack/webpack-dev-middleware" target="_blank" rel="external">webpack-dev-middleware</a> 和 <a href="https://github.com/glenjamin/webpack-hot-middleware" target="_blank" rel="external">webpack-hot-middleware</a>。具体的实现也跟这里差不多的思路，就不展开了。提供部分主要代码，基于 Express</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// webpack.config.js</span></div><div class="line">&#123;</div><div class="line">    entry: [</div><div class="line">        <span class="string">'webpack-hot-middleware/client?reload=true'</span>,</div><div class="line">        <span class="string">'webpack/hot/dev-server'</span>,</div><div class="line">        <span class="string">'./src/index.html'</span></div><div class="line">    ],</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// server.js</span></div><div class="line">compiler = webpack(utils.extendOptions(webpackDevConf));</div><div class="line"></div><div class="line">app.use(webpackDevMiddleware(compiler, &#123;</div><div class="line">    noInfo: <span class="literal">true</span>,</div><div class="line">    quiet: <span class="literal">false</span>,</div><div class="line">    lazy: <span class="literal">false</span>,</div><div class="line">    watchOptions: &#123;</div><div class="line">        aggregateTimeout: <span class="number">300</span>,</div><div class="line">        poll: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    stats: &#123;</div><div class="line">        colors: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">&#125;));</div><div class="line"></div><div class="line">app.use(webpackHotMiddleware(compiler));</div></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>以前会把 webpack 与 FIS3 比较，并尝试配合 Gulp 之类的任务管理工具放在项目中去处理各种开发需求和多人协作，然后会觉得在不同项目中跳跃的时候 webpack 的配置文件会造成不方便和额外的使用成本。然而最近几个自己玩耍的项目都使用 webpack 作为打包工具，可以看到启动一个项目十分简单，而且 webpack 足够强大去满足自己的各种需求，开发体验甩了 FIS3 一大截，特别是配合 React 的开发体验更是愉悦。</p>
<p>HMR 真是极好~<br>webpack 真是极好~</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08140/" class="prev">PREV</a><a href="/2016/06280/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 <a href="http://cupools.github.io">liyh</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-67000695-1",'auto');ga('send','pageview');</script></body></html>