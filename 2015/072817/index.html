<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 了不起的Node.js · 一环的笔记</title><meta name="description" content="了不起的Node.js - liyh"><meta name="description" content="呀在北京的第四本书是 node。之前草草过了一遍《node高级程序设计》发现没消化下去，又要重新开始了。买了转换口还是没得愉快地上网啊
安装
REPL模式（ Read-Evaluate-Print-Loop，输入 -求值 -输出 -循环）,即交互式命令行解析器

Javascript概述
V8中要获取对象上的自有属性，可以通过 Object.keys(obj)
建议为函数命名，有利于调试
__pr">
<meta property="og:type" content="article">
<meta property="og:title" content="了不起的Node.js">
<meta property="og:url" content="http://cupools.github.io/2015/072817/index.html">
<meta property="og:site_name" content="一环的笔记">
<meta property="og:description" content="呀在北京的第四本书是 node。之前草草过了一遍《node高级程序设计》发现没消化下去，又要重新开始了。买了转换口还是没得愉快地上网啊
安装
REPL模式（ Read-Evaluate-Print-Loop，输入 -求值 -输出 -循环）,即交互式命令行解析器

Javascript概述
V8中要获取对象上的自有属性，可以通过 Object.keys(obj)
建议为函数命名，有利于调试
__pr">
<meta property="og:updated_time" content="2016-08-26T08:01:41.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="了不起的Node.js">
<meta name="twitter:description" content="呀在北京的第四本书是 node。之前草草过了一遍《node高级程序设计》发现没消化下去，又要重新开始了。买了转换口还是没得愉快地上网啊
安装
REPL模式（ Read-Evaluate-Print-Loop，输入 -求值 -输出 -循环）,即交互式命令行解析器

Javascript概述
V8中要获取对象上的自有属性，可以通过 Object.keys(obj)
建议为函数命名，有利于调试
__pr"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://cupools.github.io/atom.xml" title="一环的笔记"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/archives/" target="" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="https://github.com/cupools" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="mailto:cupools@gmail.com" target="" class="nav-list-link">Gmail</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">了不起的Node.js</h1><div class="post-info">Jul 28, 2015<ul class="post-tag-list"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/读书笔记/">读书笔记</a></li></ul></div><div class="post-content"><p>呀在北京的第四本书是 node。之前草草过了一遍《node高级程序设计》发现没消化下去，又要重新开始了。买了转换口还是没得愉快地上网啊</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul>
<li>REPL模式（ Read-Evaluate-Print-Loop，输入 -求值 -输出 -循环）,即交互式命令行解析器</li>
</ul>
<h2 id="Javascript概述"><a href="#Javascript概述" class="headerlink" title="Javascript概述"></a>Javascript概述</h2><ul>
<li>V8中要获取对象上的自有属性，可以通过 <code>Object.keys(obj)</code></li>
<li>建议为函数命名，有利于调试</li>
<li><code>__proto__</code> 实现继承</li>
</ul>
<a id="more"></a>
<h2 id="阻塞与非阻塞IO"><a href="#阻塞与非阻塞IO" class="headerlink" title="阻塞与非阻塞IO"></a>阻塞与非阻塞IO</h2><ul>
<li>事件轮询，Node 会先注册事件，随后不停地询问内核这些时间是否已经分发。当事件分发时，对应的回调函数会被触发，然后继续执行下去</li>
<li>错误追踪，与执行上下文相关</li>
</ul>
<h2 id="Node中的Javascript"><a href="#Node中的Javascript" class="headerlink" title="Node中的Javascript"></a>Node中的Javascript</h2><ul>
<li>global 对象，任何 global 对象上的属性都可以被全局访问到</li>
<li>process 对象，所有全局执行上下文中的内容都在 process 对象中</li>
<li>绝对模块是指 Node 通过在其内部的 node_module 查找到的模块，或者 node 内置的模块；相对模块将 <code>require</code> 指向一个相对工作目录中的文件</li>
<li><code>EventEmmiter</code> 实现事件的监听和分发</li>
</ul>
<h2 id="Node重要的API"><a href="#Node重要的API" class="headerlink" title="Node重要的API"></a>Node重要的API</h2><ul>
<li><p>CLI</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 包含了所有 Node 程序运行时的参数值</span></div><div class="line"><span class="comment">// [node, '文件路径', '程序运行参数值']</span></div><div class="line">process.argv</div><div class="line"></div><div class="line"><span class="comment">// 文件在文件系统中的目录</span></div><div class="line">__dirname</div><div class="line"></div><div class="line"><span class="comment">// 工作目录</span></div><div class="line">process.cwd()</div><div class="line"></div><div class="line"><span class="comment">// 改变工作目录</span></div><div class="line">process.chdir(<span class="string">'/home'</span>)</div><div class="line"></div><div class="line"><span class="comment">// 访问 shell 环境的变量</span></div><div class="line">process.env</div><div class="line"></div><div class="line"><span class="comment">// 将参数添加进 process.env</span></div><div class="line">$ NODE_ENV=<span class="string">"production"</span> node</div><div class="line"></div><div class="line"><span class="comment">// 退出</span></div><div class="line">process.exit(<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="comment">// NODE 程序通过在 process 对象上，</span></div><div class="line"><span class="comment">// 以事件分发的方式发送信号</span></div><div class="line">process.on(<span class="string">'SIGKILL'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 信号已收到</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// ANSI 转义码，控制格式、颜色及其他输出选项</span></div><div class="line"><span class="comment">// \033 表示转移序列开始</span></div><div class="line"><span class="comment">// [ 表示开始颜色设置</span></div><div class="line"><span class="comment">// 90 表示前景色为亮灰色</span></div><div class="line"><span class="comment">// m 表示颜色设置结束</span></div><div class="line"><span class="comment">// 39 表示将颜色设置回去</span></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'\033[90m'</span> ＋ <span class="string">'hello'</span> + <span class="string">'\033[39m'</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>fs Stream</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> stream = fs.createReadStream(<span class="string">'a.txt'</span>);</div><div class="line">stream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 处理部分内容</span></div><div class="line">&#125;);</div><div class="line">stream.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 文件读取完毕</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>fs 监视</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> file = <span class="string">'a.txt'</span>;</div><div class="line">fs.watchFile(file, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'- '</span> + file + <span class="string">' changed'</span>);</div><div class="line">&#125;);	</div><div class="line"><span class="comment">// 通过 watch 监视目录</span></div></pre></td></tr></table></figure>
</li>
<li><p>输入输出</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">process.stdout.write(<span class="string">'show me something: \n'</span>);</div><div class="line"></div><div class="line">process.stdin.setEncoding(<span class="string">'utf8'</span>);</div><div class="line">process.stdin.resume();</div><div class="line"></div><div class="line">process.stdin.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">    process.stdout.write(<span class="string">'entry: '</span> + data + <span class="string">'\n'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><ul>
<li><p>创建基本的 TCP 服务器<br>  <code>createServer</code> 回调函数会接收一个对象，传递 <code>net.Stream</code>，通常可读写<br>  <code>listen</code> 将服务器绑定在某个端口上</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> server = net.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">conn</span>) </span>&#123;</div><div class="line">    <span class="comment">// handle connection</span></div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'\033[90m    new connection\033[39m'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'\033[96m    server listening on *:3000\033[39m'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
  <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">telnet 127.0.0.1 3000</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>创建基本的 TCP 客户端</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> client = net.connect(<span class="string">'3000'</span>, <span class="string">'127.0.0.1'</span>);</div><div class="line">client.on(<span class="string">'connect'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'done'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><h3 id="头信息"><a href="#头信息" class="headerlink" title="头信息"></a>头信息</h3><ul>
<li>Content-Type：发送内容的类型（text, HTML, XML, JSON, PNG, JPEG）</li>
<li>Transfer-Encoding：默认值是 chunked，主要原因是 Node 天生的异步机制</li>
</ul>
<h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><ul>
<li><p>HTTP 服务器是更高层的 API，提供了控制和 HTTP 协议相关的功能</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 简单 http 服务器</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'http'</span>).createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.writeHead(<span class="number">200</span>, &#123; <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</div><div class="line">    res.write(<span class="string">'&lt;h1&gt;hello&lt;/h1&gt;'</span>);</div><div class="line">    res.end(req.url + req.method);</div><div class="line">&#125;).listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 简单 HTTP 客户端</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'http'</span>).request(&#123;</div><div class="line">    host: <span class="string">'127.0.0.1'</span>,</div><div class="line">    port: <span class="number">3000</span>,</div><div class="line">    url: <span class="string">'/'</span>,</div><div class="line">    method: <span class="string">'GET'</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> body = <span class="string">''</span>;</div><div class="line"></div><div class="line">    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">        body += chunk;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(body);</div><div class="line">    &#125;);</div><div class="line">&#125;).end();</div></pre></td></tr></table></figure>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 客户端请求数据</span></div><div class="line"><span class="keyword">var</span> qs = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</div><div class="line"><span class="built_in">require</span>(<span class="string">'http'</span>).request(&#123;</div><div class="line">    host: <span class="string">'127.0.0.1'</span>,</div><div class="line">    port: <span class="number">3000</span>,</div><div class="line">    url: <span class="string">'/'</span>,</div><div class="line">    method: <span class="string">'POST'</span>	<span class="comment">// 此处为 GET 时, Error: socket hang up</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> body = <span class="string">''</span>;</div><div class="line">    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">        body += chunk;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(body);</div><div class="line">    &#125;);</div><div class="line">    res.setEncoding(<span class="string">'utf8'</span>);</div><div class="line">&#125;).end( qs.stringify(&#123;name: <span class="string">"lance"</span>&#125;) );</div></pre></td></tr></table></figure>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 表单数据</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'http'</span>).createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> body = <span class="string">''</span>;</div><div class="line">    req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">        body += chunk;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        res.writeHead(<span class="number">200</span>, &#123; <span class="string">'Content-type'</span>: <span class="string">'text/html'</span> &#125;);</div><div class="line">        res.end(req.headers[<span class="string">'content-type'</span>] + <span class="string">'&lt;br&gt;'</span> + body);</div><div class="line">    &#125;);	</div><div class="line">&#125;).listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h2><h3 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h3><ul>
<li><p>Connect 是一个基于 HTTP 服务器的工具集，它提供了一种新的组织代码的方式来与请求、响应对象进行交互，称为中间件（ middleware ）。简单来说，中间件由函数组成，除了处理 <code>req</code> 和 <code>res</code> 对象之外，还接收一个 <code>next</code> 函数作为流控制</p>
</li>
<li><p>static 中间件<br>Connect 允许将中间件挂载到 URL 上。static 允许将任意一个 URL 匹配到文件系统中任意一个目录</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 挂载</span></div><div class="line">server.use(<span class="string">'/my-iamges'</span>, conn.static(<span class="string">'/path/to/	images'</span>));</div><div class="line"></div><div class="line"><span class="comment">// 设置 maxAge</span></div><div class="line">server.use(<span class="string">'/js'</span>, conn.static(<span class="string">'/path/to/js'</span>, &#123;maxAge: <span class="number">1000</span>&#125;));</div></pre></td></tr></table></figure>
</li>
<li><p>query 中间件  </p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">server.use(connect.query);</div><div class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="comment">//req.query.page = 5;</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>logger 中间件<br>  提供四种日志格式，default、dev、short、tiny</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">server.use(connect.logger(<span class="string">'dev'</span>));</div></pre></td></tr></table></figure>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</div><div class="line">connect.createServer(</div><div class="line">    connect.logger(<span class="string">'dev'</span>),</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">        res.writeHead(<span class="number">200</span>);</div><div class="line">        res.end(<span class="string">'hello'</span>);</div><div class="line">    &#125;</div><div class="line">).listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>body parse 中间件<br>  body parse 会自动检测 Content-Type 的值，也可以用于文件上传</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">server.use(connect.bodyParser());</div><div class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="comment">// req.body.myinput</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>cookie<br>浏览器发送 cookie 数据时，会将其写到 Cookie 头信息中。其数据格式和 URL 中的查询字符串类似。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">server.use(connect.cookieParser());</div><div class="line"></div><div class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="comment">// req.cookies.sercret1 = 'value1';</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>session</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</div><div class="line">connect.createServer(</div><div class="line">    connect.logger(<span class="string">'dev'</span>),</div><div class="line">    connect.bodyParser(),</div><div class="line">    connect.cookieParser(),</div><div class="line">    connect.session(&#123; secret: <span class="string">'my secret app'</span>&#125;),</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(req.session.login_in) &#123;</div><div class="line">            res.end(<span class="string">'hello'</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            next();</div><div class="line">        &#125;</div><div class="line">    &#125;, </div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">        req.session.login_in = <span class="literal">true</span>;</div><div class="line">        res.end(<span class="string">'login'</span>);</div><div class="line">    &#125;</div><div class="line">).listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h2><p><a href="http://www.expressjs.com.cn" target="_blank" rel="external">Express 官网</a></p>
<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><p>包括浏览器实现的 WebSocket API，和服务器端实现的 WebSocket 协议。前者被 W3C 标准化，后者被 IETF 标准化为 RFC 6455</p>
<h3 id="客户端实现"><a href="#客户端实现" class="headerlink" title="客户端实现"></a>客户端实现</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">'wsL//localhost:3000'</span>);</div><div class="line">wx.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    ws.send(<span class="string">'hello from client'</span>);</div><div class="line">&#125;;</div><div class="line">wx.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'data: '</span> + ev);</div><div class="line">&#125;</div><div class="line">es.onclose = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'closed'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="服务器端实现"><a href="#服务器端实现" class="headerlink" title="服务器端实现"></a>服务器端实现</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>),</div><div class="line">    wsio = <span class="built_in">require</span>(<span class="string">'websocket.io'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = server.createServer();</div><div class="line"><span class="keyword">var</span> ws = wsio.attach(app);</div><div class="line"></div><div class="line">app.use(express.static(<span class="string">'public'</span>));</div><div class="line"></div><div class="line">wx.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</div><div class="line">    socket.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'data from client: '</span> + data);</div><div class="line">        socket.send(<span class="string">'hello from server'</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
<h3 id="关于-WebSocket-的问题"><a href="#关于-WebSocket-的问题" class="headerlink" title="关于 WebSocket 的问题"></a>关于 WebSocket 的问题</h3><ul>
<li>关闭不意味着断开连接</li>
<li>JSON 编码和解码</li>
<li>重连</li>
<li>广播</li>
<li>浏览器支持</li>
</ul>
<p>通过 socket.io 解决</p>
<h2 id="Socket-IO"><a href="#Socket-IO" class="headerlink" title="Socket.IO"></a>Socket.IO</h2><h3 id="客户端实现-1"><a href="#客户端实现-1" class="headerlink" title="客户端实现"></a>客户端实现</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> socket = io.connect();</div><div class="line">socket.on(<span class="string">'my event'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(obj.my);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="服务器端实现-1"><a href="#服务器端实现-1" class="headerlink" title="服务器端实现"></a>服务器端实现</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">io.listen(app);</div><div class="line">io.sockets.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</div><div class="line">    socket.emit(<span class="string">'my event'</span>, &#123; my: <span class="string">'object'</span>&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="简单测试"><a href="#简单测试" class="headerlink" title="简单测试"></a>简单测试</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</div><div class="line">assert.ok(<span class="number">1</span> === <span class="number">1</span>);	<span class="comment">// =&gt; undefined</span></div><div class="line">assert.ok(<span class="number">1</span> === <span class="number">2</span>); <span class="comment">// =&gt; AssertionError: false == true</span></div></pre></td></tr></table></figure>
<h3 id="expect-js"><a href="#expect-js" class="headerlink" title="expect.js"></a>expect.js</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> expect = <span class="built_in">require</span>(<span class="string">'expect'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 断言值是否为真</span></div><div class="line">expect(<span class="number">1</span>).to.be.ok();</div><div class="line">expect(<span class="number">0</span>).not.to.be.ok();</div><div class="line"></div><div class="line"><span class="comment">// be/equal, 类似 ===</span></div><div class="line">expect(<span class="number">1</span>).to.be(<span class="number">1</span>);</div><div class="line">expect(<span class="number">1</span>).to.be.equal(<span class="number">2</span>);</div><div class="line"></div><div class="line"><span class="comment">// eql, 断言非严格相等，支持对象</span></div><div class="line">expect(<span class="number">1</span>).to.eql(<span class="string">'1'</span>);</div><div class="line">···</div></pre></td></tr></table></figure>
<h3 id="Mocha"><a href="#Mocha" class="headerlink" title="Mocha"></a>Mocha</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">it(<span class="string">'should completed two request'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> total = <span class="number">2</span>;</div><div class="line">    request.get(<span class="string">'example.com/a'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(res.status !== <span class="number">200</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error'</span>);</div><div class="line">        total -- || done();</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    request.get(<span class="string">'example.com/b'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(res.status !== <span class="number">200</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error'</span>);</div><div class="line">        total -- || done();</div><div class="line">    &#125;);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="BDD风格"><a href="#BDD风格" class="headerlink" title="BDD风格"></a>BDD风格</h3><p>行为驱动开发中，定义系统的行为是主要工作，而对系统行为的描述则变成了测试标准。上面的测试代码都属于BDD风格</p>
<h3 id="TDD风格"><a href="#TDD风格" class="headerlink" title="TDD风格"></a>TDD风格</h3><p>测试驱动开发，与 BDD 类似，但组织方式是使用测试集（suite）和测试（test）。每个测试集都有 <code>setup</code> 和 <code>teardown</code> 函数，这些方法会在测试集中的测试执行前执行，它们的作用是为了避免代码重复以及最大限度使得测试之间相互独立</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">suit(<span class="string">'net'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    suit(<span class="string">'Stream'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> client;</div><div class="line">        </div><div class="line">        suitSetup(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            client.on(<span class="string">'connect'</span>, done);</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        test(<span class="string">'connect event'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            client.on(<span class="string">'connect'</span>, done);	</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        test(<span class="string">'receiving data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            client.write(<span class="string">''</span>);</div><div class="line">            client.once(<span class="string">'data'</span>, done);</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        suiteTeardown(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            client.end();</div><div class="line">        &#125;);	</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="export风格"><a href="#export风格" class="headerlink" title="export风格"></a>export风格</h3><p>export 风格使用 node 模块系统来输出测试，每一个 export 的键都表示测试集，嵌套的测试集可以用子对象来表示</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">exports.Array = &#123;</div><div class="line">    <span class="string">'#indexOf'</span>: &#123;</div><div class="line">        <span class="string">'should return -1 when the value is not present'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">        <span class="string">'should return the correct index if present'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h6 id="小记：内容十分简单，与之前看过的《NodeJS高级程序设计》差了很多，但应该适合初学者；介绍了基本web应用。中间穿插了个-Java-SSH-作业导致这本书拖了比较长的时间。看完阮一峰的-nodejs-笔记后回来看这边，发现很多重要的对象和概念书上都没提到。"><a href="#小记：内容十分简单，与之前看过的《NodeJS高级程序设计》差了很多，但应该适合初学者；介绍了基本web应用。中间穿插了个-Java-SSH-作业导致这本书拖了比较长的时间。看完阮一峰的-nodejs-笔记后回来看这边，发现很多重要的对象和概念书上都没提到。" class="headerlink" title="小记：内容十分简单，与之前看过的《NodeJS高级程序设计》差了很多，但应该适合初学者；介绍了基本web应用。中间穿插了个 Java SSH 作业导致这本书拖了比较长的时间。看完阮一峰的 nodejs 笔记后回来看这边，发现很多重要的对象和概念书上都没提到。"></a>小记：内容十分简单，与之前看过的《NodeJS高级程序设计》差了很多，但应该适合初学者；介绍了基本web应用。中间穿插了个 Java SSH 作业导致这本书拖了比较长的时间。看完阮一峰的 nodejs 笔记后回来看这边，发现很多重要的对象和概念书上都没提到。</h6></div></article></div></section><footer><div class="paginator"><a href="/2015/080118/" class="prev">PREV</a><a href="/2015/071723/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2017 <a href="http://cupools.github.io">liyh</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-67000695-1",'auto');ga('send','pageview');</script></body></html>